# VWAP 支撐策略 - 簡易版停損停利規則 (Linear 5-Step v1)

## 🛑 1. 邏輯優先級 (Execution Priority Stack)
程式必須於每一筆 Tick (或 Bar 更新時) 依序檢查下列條件。一旦任一條件觸發，執行對應動作並停止後續檢查：

1.  **硬停損 (Hard Stop Loss)**：權限最高，無條件清倉。
2.  **收盤強制出場 (Time Exit)**：13:25 到達時強制清倉。
3.  **逃命機制 (Bailout)**：**僅在已有停利單成交後啟動**，一旦觸發回檔紅線，**全數市價出場**。
4.  **停利掛單 (Take Profit)**：標準 Limit Order 等待成交。

---

## 🛑 2. 硬停損規則 (Hard Stop Loss)

* **基準價格**：進場當下的 $VWAP$ (Entry VWAP)。
* **停損價格 ($P_{stop}$)**：$VWAP_{entry} \times 0.997$ (固定值)。
* **觸發條件**：$Current\_Price < P_{stop}$。
* **執行動作**：
    1.  **Cancel All**：取消所有未成交的掛單。
    2.  **Close All**：以市價 (Market Order) 出清帳戶內所有剩餘部位。

---

## ⚠️ 3. 逃命機制 (Bailout)

**目的**：保護已實現利潤，防止假突破後的獲利回吐。
**前置條件 (Activation Condition)**：**必須至少有一筆停利單 (如 Order #1) 已經成交**。若尚未有任何停利成交，即使價格下跌，也不觸發此機制 (交由 Hard SL 處理)。

* **基準價格**：**進場當下的 Day High** ($DH_{entry}$)。
* **觸發條件**：$Current\_Price \le DH_{entry} \times (1 - 0.8\%)$。
* **執行動作 (Clean Sweep)**：
    1.  **Cancel All**：立即取消上方所有剩餘掛單。
    2.  **Close All**：將剩餘所有庫存以 **市價 (Market)** 全數拋售。

---

## 💰 4. 停利規則 (Profit Taking - 5-Step Linear)

### 4.1 初始參數設定
進場時快照以下數據：
* **DH (Day High)**：當日最高價。
* **總股數 ($Q_{total}$)**。

### 4.2 五階層線性鋪單 (5-Step Linear Grid)

將總部位分為 5 等份，均勻分佈於 $DH - 1 \text{ tick}$ 至 $DH + 3\%$ 之間。

* **單筆數量 ($Q_{base}$)**：$\lfloor Q_{total} \times 20\% \rfloor$。
* **餘數處理**：所有無法整除的餘數，歸入 **第 5 筆 (最高價)** 訂單。
* **漲停保護**：若計算目標價 $> Limit\_Up$，則修正為 $Limit\_Up$。

| 階層 (Order ID) | 價格邏輯 (Target Price) | 數量 (Qty) |
| :--- | :--- | :--- |
| **Order #1** | $DH - 1 \text{ tick}$ | $Q_{base}$ |
| **Order #2** | 線性內插點 1 (Interpolated) | $Q_{base}$ |
| **Order #3** | 線性內插點 2 (Interpolated) | $Q_{base}$ |
| **Order #4** | 線性內插點 3 (Interpolated) | $Q_{base}$ |
| **Order #5** | $DH \times 1.03$ (需 Tick 校正) | $Q_{total} - (Q_{base} \times 4)$ |

> **線性計算公式**：
> $Start = DH - 1 \text{ tick}$
> $End = DH \times 1.03$
> $Step = (End - Start) / 4$
> $Price_i = Start + (Step \times i)$ for $i \in [0, 4]$

---

## ⏰ 5. 時間出場 (Time Exit)

* **觸發時間**：**13:25:00** (台股收盤前 5 分鐘)。
* **執行動作**：
    1.  **Cancel All**：取消盤面上所有未成交掛單。
    2.  **Market Close**：以市價 (Market) 或 跌停價 (Limit Down) 拋售剩餘所有部位，確保清倉。

---

